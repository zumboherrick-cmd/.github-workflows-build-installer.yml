name: Build Installer + Portable ZIP (WeChat Image Optimizer + GPT)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create project files
        shell: bash
        run: |
          set -e
          mkdir -p app && cd app

          # package.json
          printf '{\n' > package.json
          printf '  "name": "wechat-image-optimizer",\n' >> package.json
          printf '  "version": "0.2.0",\n' >> package.json
          printf '  "description": "Drag WeChat images in, optimize and generate GPT titles",\n' >> package.json
          printf '  "main": "main.js",\n' >> package.json
          printf '  "type": "commonjs",\n' >> package.json
          printf '  "scripts": { "start": "electron .", "dist": "electron-builder -w" },\n' >> package.json
          printf '  "build": {\n' >> package.json
          printf '    "appId": "com.example.wechatimgopt",\n' >> package.json
          printf '    "productName": "WeChat Image Optimizer",\n' >> package.json
          printf '    "files": ["main.js","preload.js","renderer.js","index.html"],\n' >> package.json
          printf '    "win": { "target": "nsis", "artifactName": "WeChat-Image-Optimizer-Setup-${version}.exe" }\n' >> package.json
          printf '  },\n' >> package.json
          printf '  "devDependencies": { "electron": "^29.0.0", "electron-builder": "^24.13.3" },\n' >> package.json
          printf '  "dependencies": { "openai": "^4.57.0", "sharp": "^0.33.3" }\n' >> package.json
          printf '}\n' >> package.json

          # main.js
          cat > main.js <<'JS'
const { app, BrowserWindow, ipcMain } = require("electron");
const path = require("path"); const fs = require("fs"); const sharp = require("sharp");
const SETTINGS_PATH = path.join(app.getPath("userData"), "settings.json");
function loadSettings(){ try{ return JSON.parse(fs.readFileSync(SETTINGS_PATH,"utf-8")); }catch{ return { openaiKey: process.env.OPENAI_API_KEY || "", outW:1200,outH:1200,pad:40 }; } }
function saveSettings(obj){ fs.writeFileSync(SETTINGS_PATH, JSON.stringify(obj,null,2)); }
function createWindow(){ const win=new BrowserWindow({ width:980,height:740,webPreferences:{ preload:path.join(__dirname,"preload.js") } }); win.loadFile("index.html"); }
app.whenReady().then(()=>{ createWindow(); app.on("activate",()=>{ if(BrowserWindow.getAllWindows().length===0) createWindow(); }); });
app.on("window-all-closed",()=>{ if(process.platform!=="darwin") app.quit(); });

ipcMain.handle("process-images", async (_evt, files, opts)=>{
  const s=loadSettings(); const outW=Number(opts?.outW||s.outW||1200), outH=Number(opts?.outH||s.outH||1200), pad=Number(opts?.pad||s.pad||40);
  const bg=opts?.background||"#FFFFFF", ac=!!opts?.autocontrast, sh=Math.max(0,Math.min(Number(opts?.sharpen||1),2));
  const badge=opts?.badge||{enable:false}; const outDir=path.join(process.cwd(),"outputs"); if(!fs.existsSync(outDir)) fs.mkdirSync(outDir,{recursive:true});
  const results=[]; for(const f of files){ try{
    let img=sharp(f,{failOn:false}).rotate().resize({ width:Math.max(1,outW-pad*2), height:Math.max(1,outH-pad*2), fit:"inside", withoutEnlargement:true });
    if(ac) img=img.normalize(); if(sh>0) img=img.sharpen(sh);
    const canvas=sharp({ create:{ width:outW,height:outH,channels:4,background:{r:255,g:255,b:255,alpha:1} } });
    const buf=await img.png().toBuffer(); const m=await sharp(buf).metadata();
    const left=Math.floor((outW-(m.width||0))/2), top=Math.floor((outH-(m.height||0))/2);
    let composed=await canvas.composite([{ input:buf, left, top }]).png().toBuffer();
    if(bg && bg!=="keep"){ const hex=bg.replace("#",""); const rgb={ r:parseInt(hex.slice(0,2)||"ff",16), g:parseInt(hex.slice(2,4)||"ff",16), b:parseInt(hex.slice(4,6)||"ff",16) }; composed=await sharp(composed).flatten({ background: rgb }).toBuffer(); }
    if(badge.enable && badge.text){
      const svg = makeBadgeSVG(badge.text, Number(badge.fontSize)||44, badge.fill||"#FFFF00", badge.textColor||"#141414");
      const bImg=sharp(Buffer.from(svg)).png(); const bMeta=await bImg.metadata();
      let bx=24,by=24; if(badge.position==="top-right"){bx=outW-(bMeta.width||0)-24;by=24;} if(badge.position==="bottom-left"){bx=24;by=outH-(bMeta.height||0)-24;} if(badge.position==="bottom-right"){bx=outW-(bMeta.width||0)-24;by=outH-(bMeta.height||0)-24;}
      composed=await sharp(composed).composite([{ input: await bImg.toBuffer(), left: bx, top: by }]).toBuffer();
    }
    const outName=path.basename(f).replace(/\.(png|jpe?g|webp|gif|bmp|tiff)$/i,""); const outPath=path.join(outDir, `${outName}_optimized_${outW}x${outH}.jpg`);
    await sharp(composed).jpeg({quality:92}).toFile(outPath);
    results.push({ input:f, output:outPath, previewB64: fs.readFileSync(outPath,"base64") });
  }catch(err){ results.push({ input:f, error:String(err) }); } }
  return results;
});
function makeBadgeSVG(text, fontSize=44, fill="#FFFF00", color="#141414"){
  const padX=18,padY=10,r=14; const tw=Math.ceil(text.length*fontSize*0.6); const bw=tw+padX*2,bh=fontSize+padY*2;
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${bw}" height="${bh}"><rect x="0" y="0" rx="${r}" ry="${r}" width="${bw}" height="${bh}" fill="${fill}"/><text x="${padX}" y="${bh-padY-4}" fill="${color}" font-family="system-ui,Arial" font-size="${fontSize}">${text}</text></svg>`;
}
ipcMain.handle("generate-gpt", async (_evt, payload)=>{
  try{
    const s=loadSettings(); const apiKey=payload?.openaiKey||s.openaiKey||process.env.OPENAI_API_KEY||""; if(!apiKey) throw new Error("请先填写 OpenAI API Key");
    const OpenAI=(await import("openai")).default; const client=new OpenAI({ apiKey });
    const {brand="",material="",spec="",shape="",use=""}=payload||{};
    const sys="你是淘宝文案专家，避免极限词，标题≤60字。";
    const user=`品牌：${brand}；材质：${material}；规格：${spec}；形状：${shape}；适用：${use}。请输出 JSON：{ "title": "...", "bullets": ["...","...","...","...","..."], "badge_text": "..." }`;
    const r=await client.responses.create({ model:"gpt-4o-mini", input:[{role:"system",content:sys},{role:"user",content:user}] });
    const text=(r.output_text||"").trim().replace(/^```(json)?|```$/g,""); let data={}; try{ data=JSON.parse(text); }catch{ data={}; }
    if(payload?.rememberKey && payload.openaiKey){ saveSettings({ ...s, openaiKey: payload.openaiKey }); }
    return { ok:true, title:data.title||`${brand} ${material} ${spec} ${shape} DIY饰品配件`, bullets:Array.isArray(data.bullets)?data.bullets.slice(0,5):["多规格可选","白底突出主体","多场景适用","手作/备货皆宜","发货及时"], badge_text:data.badge_text||"多规格可选" };
  }catch(e){ return { ok:false, error:String(e) }; }
});
JS

          # preload.js
          cat > preload.js <<'JS'
const { contextBridge, ipcRenderer } = require("electron");
contextBridge.exposeInMainWorld("api", {
  processImages: (files, opts) => ipcRenderer.invoke("process-images", files, opts),
  generateGPT:  (payload)     => ipcRenderer.invoke("generate-gpt", payload)
});
JS

          # renderer.js
          cat > renderer.js <<'JS'
const $=(s)=>document.querySelector(s); let files=[];
function getOpts(){ return { outW:parseInt($("#outW").value||"1200",10), outH:parseInt($("#outH").value||"1200",10), pad:parseInt($("#pad").value||"40",10),
  background: $("#bgKeep").checked?"keep":($("#bgColor").value||"#FFFFFF"), autocontrast: $("#autocontrast").checked,
  sharpen: parseInt($("#sharpen").value||"1",10),
  badge:{ enable:$("#badgeEnable").checked, text:$("#badgeText").value||"", position:$("#badgePos").value||"top-left", fontSize:parseInt($("#badgeFont").value||"44",10), fill:"#FFFF00", textColor:"#141414" } }; }
function addFiles(list){ for(const f of list){ if(/\.(png|jpe?g|webp|gif|bmp|tiff)$/i.test(f.path||f.name)){ files.push(f.path||f.name); const li=document.createElement("li"); li.textContent=f.path||f.name; $("#fileList").appendChild(li); } } $("#count").textContent=files.length; }
window.addEventListener("DOMContentLoaded",()=>{
  const drop=$("#drop"); drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("hover");}); drop.addEventListener("dragleave",()=>drop.classList.remove("hover"));
  drop.addEventListener("drop",e=>{e.preventDefault();drop.classList.remove("hover"); addFiles(e.dataTransfer.files);});
  $("#pick").addEventListener("change",e=>addFiles(e.target.files));
  $("#run").addEventListener("click",async()=>{ if(!files.length){alert("请先拖入或选择图片");return;} $("#run").disabled=true; $("#log").textContent="处理中...";
    const res=await window.api.processImages(files,getOpts()); $("#previews").innerHTML="";
    res.forEach(r=>{ const card=document.createElement("div"); card.style.bor
